import idc

def main():
    # TODO: Get these values using regex or something
    decryption_key = 0xAF4CD412
    payload_addr = 0x1000ABAC
    payload_size = 0xEC72

    encrypted_payload = idc.get_bytes(payload_addr, payload_size)
    decrypted_payload = bytearray(payload_size)
    for i in range(payload_size):
        decrypted_payload[i] = encrypted_payload[i] ^ (decryption_key & 0xFF)
        next_key = (decryption_key << 0x10) & 0xFFFFFFFF
        next_key += decryption_key >> 0x10
        next_key = (next_key * 0xE52A182B) & 0xFFFFFFFF
        next_key = (next_key + 0x9D277B18) & 0xFFFFFFFF
        decryption_key = next_key
    
    with open('unpacked_payload.bin', 'wb') as unpacked_bin:
        unpacked_bin.write(decrypted_payload)

if __name__ == '__main__':
    main()
