import idautils

# TODO: Obtain the address of decryption function automatically
DECRYPT_FUNC_ADDR = 0x972E7A

def main():
    counter = 0

    for ref in idautils.XrefsTo(DECRYPT_FUNC_ADDR):
        ea = ref.frm

        # Obtain encrypted string
        encrypted_string = ''
        while ea != idc.BADADDR:
            ea = idc.prev_head(ea)
            if idc.print_insn_mnem(ea) == 'push':
                encrypted_string = idc.get_strlit_contents(idc.get_operand_value(ea, 0), 
                                                           -1, STRTYPE_C)
                break
        
        if len(encrypted_string) == 0:
            print('[-] String not found', ref.frm)
            continue
        
        # XOR decryption using hardcoded key
        decrypted_string = ''
        for char in encrypted_string:
            # TODO: Obtain the key automatically
            decrypted_string += chr(char ^ 0x3F)
        
        # Output result
        print('[*] Decrypted', decrypted_string, 'at', hex(ref.frm))

        # Set comment with decrypted string at instruction calling decryption function
        idc.set_cmt(ref.frm, 'Decrypted: ' + decrypted_string, False)
        counter += 1
    
    print('[+] Decrypted', counter, 'strings')

if __name__ == '__main__':
    main()
