# Analyzing malicious OneNote document file that leads to Emotet infection

## Dump malicious JScript

Open up malicious OneNote document file (05800.one) on OneNote.
Right click on hidden button that executes malicious JScript, and click on `Save As...` button to dump it to file.

## Analyze JScript (Stage 1)

By opening up the extracted JScript file on text editor, I noticed that there are 2 string stored inside variable `Yqr3` and `KkF`.

```
var Yqr3 = "owIqmHe73b300f.......0524085";
var OAbBC90 = "impression hot action wage arrive main";
var CW41p = Dd1yi(Yqr3, "owIqmHe7");
var uC = "television justify presentation occupy fun shock relief immediate affect staff sharp technology creature hat border print scheme glasses official college strange centre suit them sensitive";
var KkF = "Y=SHQAzc5d11241.......74e186b";
var bZqNXxH = 3560959;
var mAkRpx = "N<XFrW9%qZeCJTenT7n^%BWS!D&Yn{";
var SD38 = Dd1yi(KkF, "Y=SHQAz");
```

Interestingly, other than few characters at the start of string (`owIqmHe7` and `Y=SHQAz`), the string looked like the hex-string.
So I have assumed that function `Dd1yi` is used to delete meaningless string, and build up hex-string which can be encoded payload or something.
By reading through the code, I noticed that script is performing xor decryption against data (which is built by unhexlify-ing the hex-string mentioned above).
I have wrote Python script that performs the decryption as the script does, and obtained second stage payload (script).

```py
# Most part of string is snipped since its very long.
# Check full version of script at extract_second_stage.py
encoded_str1 = "owIqmHe73b300f.......0524085".replace('owIqmHe7', '')
encoded_str2 = "Y=SHQAzc5d11241.......74e186b".replace('Y=SHQAz', '')

payload = bytes.fromhex(encoded_str1 + encoded_str2)
xor_key = bytes.fromhex('5d4561695763527e663150')

def main():
    result = ''
    for i, c in enumerate(payload):
        result += chr(c ^ xor_key[i % len(xor_key)])
    print(result)

if __name__ == '__main__':
    main()
```

## Analyze JScript (Stage 2)

Stage 2 payload has less obfuscation compared to previous one, though most of them were basic string obfuscation with replacement.
Following are the brief explanation of what script does:

1. Try to download zip file containing Emotet DLL payload
2. Save as `[0-9a-z]{9}.zip` inside temporary folder (filename will be random)
3. Create `[0-9a-z]{9}` folder inside temporary folder, and extract DLL payload from zip file there (folder name will be random)
4. Delete zip file saved at step 2
5. Load DLL file using `regsvr32.exe`

## IoCs

| Type                 | Indicator                                                         | Remark                                                                                           |
| -------------------- | ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| SHA256 Hash          | a43e0864905fe7afd6d8dbf26bd27d898a2effd386e81cfbc08cae9cf94ed968  | SHA256 hash of malicious OneNote document file. Obtained from https://tria.ge/230318-aseygsaf22. |
| Payload Download URL | https[:]//oopt[.]center[:]443/bitrix/HKD1OCEK4mWEc0/              |                                                                                                  |
| Payload Download URL | http[:]//aristonbentre[.]com/slideshow/O1uPzXd2YscA/              |                                                                                                  |
| Payload Download URL | https[:]//applink[.]gr/wp-admin/pWxO42PQrVL0ja5LTfhy/             |                                                                                                  |
| Payload Download URL | http[:]//attatory[.]com/i-bmail/6AfEa8G0W8NOtUh7hqFj/             |                                                                                                  |
| Payload Download URL | http[:]//asakitreks[.]com/uploads/ce8u7/                          |                                                                                                  |
| Payload Download URL | https[:]//www[.]ata-sistemi[.]si/wp-admin/cVDQapxmtAQQq1gr3/      |                                                                                                  |
| Payload Download URL | http[:]//bvdkhuyentanyen[.]vn/files/TKK8yKdEvyYAbBE5avb/          |                                                                                                  |
| Payload Download URL | http[:]//bluegdps100[.]7m[.]pl/app/Ac8wwulKxqZjc/                 |                                                                                                  |
| Payload Download URL | https[:]//casapollux[.]com/Bilder/GDo3zoURY/                      |                                                                                                  |
