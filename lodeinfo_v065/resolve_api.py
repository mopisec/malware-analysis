import glob, os, pefile

# Directory of DLLs to calculate and compare hash with hardcoded value
DLL_SEARCH_DIR = b'C:\\Windows\\SysWOW64\\'

def calc_hash(target: bytes, is_dll_hash: bool) -> int:
    result = 0
    for char in target:
        if is_dll_hash:
            char |= 0x20
        result = ((result << 0x18) & 0xFFFFFFFF) | (result >> 0x8)
        result = (result + char) & 0xFFFFFFFF
        result ^= 0x2035C4DD
    return result

def find_dll_from_hash(hash_value: int) -> str:
    dll_path_list = [p for p in glob.glob(DLL_SEARCH_DIR + b'*.dll')]
    for dll_path in dll_path_list:
        dll_filename = os.path.basename(dll_path)
        if calc_hash(dll_filename, True) ^ 0x12345678 == hash_value:
            return dll_path.decode()
    return 'NOT FOUND'

def find_api_from_hash(hash_value: int, dll_path: str) -> str:
    pe = pefile.PE(dll_path)
    api_list = [e.name for e in pe.DIRECTORY_ENTRY_EXPORT.symbols]
    for api_name in api_list:
        if api_name != None:
            if calc_hash(api_name, False) == hash_value:
                return api_name.decode()
    return 'NOT FOUND'

def main():
    '''
    seg000:0000E62B check_hash:                             ; CODE XREF: seg000:0000E5D4↑j
    seg000:0000E62B                 xor     edi, 12345678h
    seg000:0000E631                 cmp     edi, 13FDAD7Bh
    seg000:0000E637                 jz      short hash_matched
    seg000:0000E639                 mov     ebx, [ebx+LDR_DATA_TABLE_ENTRY.InLoadOrderLinks.Flink]
    '''
    dll_path = find_dll_from_hash(0x13FDAD7B)

    '''
    seg000:0000E6EB                 cmp     dword ptr [ebp-4], 0BADEEE3Fh
    seg000:0000E6F2                 jnz     short loc_E6F7
    seg000:0000E6F4                 mov     [ebp-34h], eax
    seg000:0000E6F7
    seg000:0000E6F7 loc_E6F7:                               ; CODE XREF: seg000:0000E6F2↑j
    seg000:0000E6F7                 cmp     dword ptr [ebp-4], 681938B9h
    seg000:0000E6FE                 jnz     short loc_E703
    seg000:0000E700                 mov     [ebp-2Ch], eax
    seg000:0000E703
    seg000:0000E703 loc_E703:                               ; CODE XREF: seg000:0000E6FE↑j
    seg000:0000E703                 cmp     dword ptr [ebp-4], 0BA33443Eh
    seg000:0000E70A                 jnz     short loc_E70F
    seg000:0000E70C                 mov     [ebp-8], eax
    '''
    print(find_api_from_hash(0xBADEEE3F, dll_path))
    print(find_api_from_hash(0x681938B9, dll_path))
    print(find_api_from_hash(0xBA33443E, dll_path))

if __name__ == '__main__':
    main()
